<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <style type="text/css">
        body, input {
            font-size: 100%;
        }
        h1{
            page-break-before: always;
        }
        h1:first-child{
            page-break-before: avoid;
        }
        table.grid {
            font-family: monospace;
            border-collapse: collapse;
            width: 100%;
            height: 18em;
        }
        div.gridContainer {
            width: 18em;
            float: left;
            margin: 0 0 1em 1em;
        }
        input.gridName {
            width: 98%;
            font-size: 100%;
            text-align: center;
        }
        input.gridSeedControl {
            width: 90%;
            /*width: 98%;*/
            text-align: center;
            font-size: 60%;
        }
        table, td {
            font-size: 110%;
            border: 1px solid black;
            text-align: center;
        }
        a.reloadLink {
            color: green;
            border: 1px solid green;
            background-color: palegreen;
            padding: 0 .2em 0 .2em;
        }
    </style>
    <script src="http://www.ethanresnick.com/diceware/diceware.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.0/seedrandom.min.js"></script>
</head>
<body>
<div id="grids"></div>
<script>
    var possible = "ABCDEFGHIJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789£!?%";
    function generateDicewareString() {
        return diceware(6).join(' ').toLowerCase();
    }
    function repopulateGrid(gridNumber) {
        var seedFromControl = document.getElementById(gridSeedControlId(gridNumber)).value;
        var gridElement = document.getElementById(buildGridId(gridNumber));
        initialiseGrid(gridElement, seedFromControl);
    }
    function initialiseGrid(grid, seed) {
        grid.innerHTML = '';
        Math.seedrandom(seed);
        for (var row = 0; row < 9; row++) {
            var tr = document.createElement('tr');
            for (var col = 0; col < 9; col++) {
                var cell = document.createElement('td');
                cell.innerHTML = possible.charAt(Math.floor(Math.random() * possible.length));
                tr.appendChild(cell);
            }
            grid.appendChild(tr);
        }
        localStorage[grid.getAttribute('id')] = seed;
    }
    function buildGridId(gridNumber) {
        return 'gridId-' + gridNumber;
    }
    function reloadGrid(gridNumber) {
        var gridId = buildGridId(gridNumber);
        var grid = document.getElementById(gridId);
        var seed = generateDicewareString();

        localStorage[gridId] = seed;
        var gridSeedControl = document.getElementById(gridSeedControlId(gridNumber))
        gridSeedControl.value = seed;
        initialiseGrid(grid, seed);
    }
    function gridSeedControlId(gridNumber) {
        return 'gridSeedControl' + gridNumber;
    }
    function gridNameId(gridNumber) {
        return 'gridName' + gridNumber;
    }
    function saveGridName(gridNumber) {
        var gridName = document.getElementById(gridNameId(gridNumber));
        localStorage[gridName.id] = gridName.value;
    }
    function buildGridSeedControl(gridNumber, seed) {
        var gridSeedControl = document.createElement('input');
        gridSeedControl.id = gridSeedControlId(gridNumber);
        gridSeedControl.className = 'gridSeedControl';
        gridSeedControl.setAttribute('oninput', 'repopulateGrid(\'' + gridNumber + '\');');
        gridSeedControl.value = seed;
        return gridSeedControl;
    }
    function buildGridReloadControl(gridNumber) {
        var reloadLink = document.createElement('a');
        reloadLink.innerText = '↻';
        reloadLink.setAttribute('onClick', 'reloadGrid(' + gridNumber + ')');
        reloadLink.className = 'reloadLink';
        return reloadLink;
    }
    function buildGrid(gridId, seed) {
        var grid = document.createElement('table');
        grid.className = 'grid';
        grid.id = gridId;
        initialiseGrid(grid, seed);
        return grid;
    }
    function buildGridName(gridNumber) {
        var gridName = document.createElement('input');
        gridName.id = gridNameId(gridNumber);
        gridName.className = 'gridName';
        gridName.setAttribute('oninput', 'saveGridName(' + gridNumber + ')');
        if (!(typeof localStorage[gridNameId(gridNumber)] === 'undefined')) {
            gridName.value = localStorage[gridNameId(gridNumber)];
        }
        return gridName;
    }
    function findOrInitialiseSeed(gridId, gridNumber) {
        var seed;
        if (typeof localStorage.gridSeeds === 'undefined') {
            // never generated any grids… initialise storage for seeds
            localStorage.gridSeeds = {};
        }
        if (typeof localStorage[gridId] === 'undefined') {
            // not been populated yet
            seed = generateDicewareString();
            localStorage[gridId] = seed;
        }
        else {
            // able to retrieve stored seed
            seed = localStorage[gridId];
        }
        return seed;
    }
    function buildGridContainer(gridNumber) {
        var gridContainer = document.createElement('div');
        gridContainer.className = 'gridContainer';
        var gridId = buildGridId(gridNumber);
        var seed = findOrInitialiseSeed(gridId, gridNumber);
        gridContainer.appendChild(buildGridName(gridNumber));
        gridContainer.appendChild(buildGridSeedControl(gridNumber, seed));
        gridContainer.appendChild(buildGridReloadControl(gridNumber));
        gridContainer.appendChild(buildGrid(gridId, seed));
        return gridContainer;
    }
    for (var gridNumber = 0; gridNumber < 6; gridNumber ++) {
        document.getElementById('grids').appendChild(buildGridContainer(gridNumber));
    }

</script>
</body>
</html>